generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String                @id @default(cuid())
  email                     String                @unique
  name                      String
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  timezone                  String                @default("UTC")
  activityLogs              ActivityLog[]
  acceptedFamilyInvitations FamilyInvitation[]    @relation("FamilyInvitationsAcceptedBy")
  createdFamilyInvitations  FamilyInvitation[]    @relation("FamilyInvitationsCreatedBy")
  sentFamilyInvitations     FamilyInvitation[]    @relation("FamilyInvitationsInvitedBy")
  familyMemberships         FamilyMember[]
  fcmTokens                 FcmToken[]
  addedChildrenToGroups     GroupChildMember[]    @relation("GroupChildMemberAddedBy")
  familyGroupsAdded         GroupFamilyMember[]   @relation("GroupFamilyMemberAddedBy")
  acceptedGroupInvitations  GroupInvitation[]     @relation("GroupInvitationsAcceptedBy")
  createdGroupInvitations   GroupInvitation[]     @relation("GroupInvitationsCreatedBy")
  sentGroupInvitations      GroupInvitation[]     @relation("GroupInvitationsInvitedBy")
  magicLinks                MagicLink[]
  refreshTokens             RefreshToken[]
  drivenVehicles            ScheduleSlotVehicle[] @relation("ScheduleSlotVehicleDriver")

  @@map("users")
}

model Group {
  id             String               @id @default(cuid())
  name           String
  inviteCode     String               @unique
  familyId       String
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  description    String?
  operatingHours Json?
  timezone       String               @default("UTC")
  childMembers   GroupChildMember[]
  familyMembers  GroupFamilyMember[]
  invitations    GroupInvitation[]
  scheduleConfig GroupScheduleConfig?
  ownerFamily    Family               @relation("GroupFamily", fields: [familyId], references: [id], onDelete: Cascade)
  scheduleSlots  ScheduleSlot[]

  @@map("groups")
}

model GroupScheduleConfig {
  id            String   @id @default(cuid())
  groupId       String   @unique
  scheduleHours Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  group         Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("group_schedule_configs")
}

model GroupFamilyMember {
  familyId    String
  groupId     String
  role        GroupRole @default(MEMBER)
  addedBy     String
  joinedAt    DateTime  @default(now())
  addedByUser User      @relation("GroupFamilyMemberAddedBy", fields: [addedBy], references: [id], onDelete: Cascade)
  family      Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  group       Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([familyId, groupId])
  @@map("group_family_members")
}

model GroupChildMember {
  childId     String
  groupId     String
  addedBy     String
  addedAt     DateTime @default(now())
  addedByUser User     @relation("GroupChildMemberAddedBy", fields: [addedBy], references: [id], onDelete: Cascade)
  child       Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([childId, groupId])
  @@map("group_child_members")
}

model Child {
  id                      String              @id @default(cuid())
  name                    String
  age                     Int?
  familyId                String
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  family                  Family              @relation("FamilyChildren", fields: [familyId], references: [id], onDelete: Cascade)
  groupMemberships        GroupChildMember[]
  scheduleSlotAssignments ScheduleSlotChild[]

  @@map("children")
}

model Vehicle {
  id                      String                @id @default(cuid())
  name                    String
  capacity                Int
  familyId                String
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  scheduleSlotAssignments ScheduleSlotVehicle[]
  family                  Family                @relation("FamilyVehicles", fields: [familyId], references: [id], onDelete: Cascade)

  @@map("vehicles")
}

model ScheduleSlot {
  id                 String                @id @default(cuid())
  groupId            String
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  datetime           DateTime
  childAssignments   ScheduleSlotChild[]
  vehicleAssignments ScheduleSlotVehicle[]
  group              Group                 @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, datetime])
  @@map("schedule_slots")
}

model ScheduleSlotVehicle {
  id               String              @id @default(cuid())
  scheduleSlotId   String
  vehicleId        String
  driverId         String?
  createdAt        DateTime            @default(now())
  seatOverride     Int?
  childAssignments ScheduleSlotChild[]
  driver           User?               @relation("ScheduleSlotVehicleDriver", fields: [driverId], references: [id])
  scheduleSlot     ScheduleSlot        @relation(fields: [scheduleSlotId], references: [id], onDelete: Cascade)
  vehicle          Vehicle             @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([scheduleSlotId, vehicleId])
  @@map("schedule_slot_vehicles")
}

model ScheduleSlotChild {
  scheduleSlotId      String
  childId             String
  vehicleAssignmentId String
  assignedAt          DateTime            @default(now())
  child               Child               @relation(fields: [childId], references: [id], onDelete: Cascade)
  scheduleSlot        ScheduleSlot        @relation(fields: [scheduleSlotId], references: [id], onDelete: Cascade)
  vehicleAssignment   ScheduleSlotVehicle @relation(fields: [vehicleAssignmentId], references: [id], onDelete: Cascade)

  @@id([scheduleSlotId, childId])
  @@unique([vehicleAssignmentId, childId])
  @@map("schedule_slot_children")
}

model MagicLink {
  id            String   @id @default(cuid())
  token         String   @unique
  userId        String
  expiresAt     DateTime
  used          Boolean  @default(false)
  codeChallenge String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([codeChallenge])
  @@index([token, codeChallenge])
  @@map("magic_links")
}

model ActivityLog {
  id                String   @id @default(cuid())
  userId            String
  actionType        String
  actionDescription String
  entityType        String?
  entityId          String?
  entityName        String?
  metadata          Json?
  createdAt         DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("activity_logs")
}

model Family {
  id                       String              @id @default(cuid())
  name                     String
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  children                 Child[]             @relation("FamilyChildren")
  invitations              FamilyInvitation[]
  members                  FamilyMember[]
  groupMembers             GroupFamilyMember[]
  targetedGroupInvitations GroupInvitation[]   @relation("GroupInvitationTargetFamily")
  ownedGroups              Group[]             @relation("GroupFamily")
  vehicles                 Vehicle[]           @relation("FamilyVehicles")

  @@map("families")
}

model FamilyMember {
  id       String     @id @default(cuid())
  familyId String
  userId   String
  role     FamilyRole @default(MEMBER)
  joinedAt DateTime   @default(now())
  family   Family     @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([familyId, userId])
  @@map("family_members")
}

model FamilyInvitation {
  id              String                 @id @default(cuid())
  familyId        String
  email           String?
  role            FamilyRole             @default(MEMBER)
  personalMessage String?
  invitedBy       String
  status          FamilyInvitationStatus @default(PENDING)
  inviteCode      String
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  acceptedBy      String?
  createdBy       String
  acceptedByUser  User?                  @relation("FamilyInvitationsAcceptedBy", fields: [acceptedBy], references: [id])
  createdByUser   User                   @relation("FamilyInvitationsCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  family          Family                 @relation(fields: [familyId], references: [id], onDelete: Cascade)
  invitedByUser   User                   @relation("FamilyInvitationsInvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([inviteCode, status])
  @@index([familyId, status, expiresAt])
  @@index([email, status, expiresAt])
  @@map("family_invitations")
}

model GroupInvitation {
  id              String                @id @default(cuid())
  groupId         String
  email           String?
  role            String                @default("MEMBER")
  personalMessage String?
  invitedBy       String
  status          GroupInvitationStatus @default(PENDING)
  inviteCode      String
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  acceptedBy      String?
  createdBy       String
  targetFamilyId  String?
  acceptedByUser  User?                 @relation("GroupInvitationsAcceptedBy", fields: [acceptedBy], references: [id])
  createdByUser   User                  @relation("GroupInvitationsCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  group           Group                 @relation(fields: [groupId], references: [id], onDelete: Cascade)
  invitedByUser   User                  @relation("GroupInvitationsInvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  targetFamily    Family?               @relation("GroupInvitationTargetFamily", fields: [targetFamilyId], references: [id], onDelete: Cascade)

  @@index([inviteCode, status])
  @@index([groupId, status, expiresAt])
  @@index([targetFamilyId, status, expiresAt])
  @@index([email, status, expiresAt])
  @@map("group_invitations")
}

model FcmToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  deviceId  String?
  platform  String
  isActive  Boolean  @default(true)
  lastUsed  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([token])
  @@index([lastUsed])
  @@map("fcm_tokens")
}

model RefreshToken {
  id          String    @id @default(cuid())
  userId      String
  token       String    @unique
  tokenFamily String    @default(cuid())
  isRevoked   Boolean   @default(false)
  usedAt      DateTime?
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenFamily])
  @@map("refresh_tokens")
}

enum GroupRole {
  ADMIN
  MEMBER
}

enum FamilyRole {
  ADMIN
  MEMBER
}

enum FamilyInvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum GroupInvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

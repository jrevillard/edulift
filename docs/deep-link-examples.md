# EduLift Deep Link Examples - Concret Guide

## Overview

This document provides concrete, real-world examples of the EduLift deep link system in action across different environments, use cases, and integration scenarios.

## Environment-Specific Examples

### Development Environment

#### Configuration
```bash
# .env.development
NODE_ENV=development
DEEP_LINK_BASE_URL=edulift://
FRONTEND_URL=http://localhost:3000
LOG_LEVEL=debug
```

#### URL Generation Examples

**Group Invitation Email**
```typescript
// Input data
const groupInvitationData = {
  groupName: "Ã‰cole Saint-ExupÃ©ry",
  inviteCode: "DEV-ABC123",
  to: "parent@example.com"
};

// Generated URLs
const params = new URLSearchParams({ code: "DEV-ABC123" });
const inviteUrl = emailService.generateUrl('groups/join', params);

// Result: edulift://groups/join?code=DEV-ABC123
```

**Magic Link Authentication**
```typescript
// Input data
const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const inviteCode = "INV-XYZ789";

// Generated URL
const magicLinkUrl = `${process.env.FRONTEND_URL}/auth/verify?token=${token}&inviteCode=${inviteCode}`;

// Result: http://localhost:3000/auth/verify?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&inviteCode=INV-XYZ789
```

**Email Template Output**
```html
<!-- Generated HTML email -->
<div style="text-align: center; margin: 30px 0;">
  <a href="edulift://groups/join?code=DEV-ABC123"
     style="background: #10b981; color: white; padding: 15px 30px;">
    Join Group
  </a>
</div>
<div style="background: #f1f5f9; padding: 20px;">
  <p>ðŸ“± If the button doesn't work:</p>
  <p>Copy and paste this link:<br>
    <span style="background: white; padding: 8px; font-family: monospace;">
      edulift://groups/join?code=DEV-ABC123
    </span>
  </p>
</div>
```

#### Mobile App Testing
```bash
# Test deep link with Android ADB
adb shell am start -W -a android.intent.action.VIEW \
  -d "edulift://groups/join?code=DEV-ABC123"

# Test with iOS Simulator
xcrun simctl openurl booted "edulift://groups/join?code=DEV-ABC123"
```

### Staging Environment

#### Configuration
```bash
# Generated by Ansible
NODE_ENV=staging
DEEP_LINK_BASE_URL=https://transport.tanjama.fr:50443/
FRONTEND_URL=https://transport.tanjama.fr:50443
```

#### URL Generation Examples

**Family Invitation**
```typescript
// Input data
const familyInvitationData = {
  familyName: "Famille Dupont",
  inviteCode: "STAGE-FAM456",
  personalMessage: "Bienvenue dans notre groupe de covoiturage !",
  to: "newmember@example.com"
};

// Generated URLs
const params = new URLSearchParams({ code: "STAGE-FAM456" });
const inviteUrl = emailService.generateUrl('families/join', params);

// Result: https://transport.tanjama.fr:50443/families/join?code=STAGE-FAM456
```

**Schedule Notification**
```typescript
// Input data
const scheduleData = {
  groupName: "CollÃ¨ge Jean Moulin",
  datetime: "2025-01-15T08:30:00Z",
  changeType: "DRIVER_ASSIGNED"
};

// Generated URL
const dashboardUrl = emailService.generateUrl('dashboard');

// Result: https://transport.tanjama.fr:50443/dashboard
```

#### Real Device Testing
```bash
# Generate QR code for mobile testing
echo "https://transport.tanjama.fr:50443/groups/join?code=STAGE-TEST123" | \
  qrencode -o test-qr.png

# Test with actual mobile device
# 1. Install staging build of mobile app
# 2. Scan QR code or click link in test email
# 3. Verify app opens to correct screen
```

### Production Environment

#### Configuration
```bash
# Generated by Ansible
NODE_ENV=production
DEEP_LINK_BASE_URL=https://transport.tanjama.fr/
FRONTEND_URL=https://transport.tanjama.fr
```

#### URL Generation Examples

**Real User Invitation**
```typescript
// Real-world scenario: School administrator invites parents
const realInvitationData = {
  groupName: "Transport Ã‰cole Primaire Centre",
  inviteCode: "PROD-2025-001",
  to: "parent@ecole-centre.fr"
};

// Generated URL
const params = new URLSearchParams({ code: "PROD-2025-001" });
const inviteUrl = emailService.generateUrl('groups/join', params);

// Result: https://transport.tanjama.fr/groups/join?code=PROD-2025-001
```

**Daily Reminder Notification**
```typescript
// Input data
const reminderData = {
  groupName: "LycÃ©e Victor Hugo",
  tomorrowSlots: [
    {
      datetime: "2025-01-16T08:00:00Z",
      driverName: "Marie Martin",
      vehicleName: "CitroÃ«n Berlingo",
      children: ["Lucas Dubois", "Clara Bernard"]
    }
  ]
};

// Generated URL
const scheduleUrl = emailService.generateUrl('dashboard');

// Result: https://transport.tanjama.fr/dashboard
```

## Email Template Examples

### Group Invitation Email (Production)

**Generated HTML**
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduLift - Group Invitation</title>
</head>
<body style="font-family: Arial, Helvetica, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8fafc;">
  <div style="text-align: center; margin-bottom: 30px;">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..." alt="EduLift" style="max-width: 120px;">
  </div>

  <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <p style="font-size: 16px; line-height: 1.5;">Bonjour,</p>
    <p style="font-size: 16px; line-height: 1.5;">Vous avez Ã©tÃ© invitÃ© Ã  rejoindre le groupe <strong>Transport Ã‰cole Primaire Centre</strong> sur EduLift.</p>
    <p style="font-size: 16px; line-height: 1.5;">EduLift vous aide Ã  organiser les trajets domicile-Ã©cole de maniÃ¨re collaborative avec d'autres parents.</p>

    <!-- Mobile-friendly button -->
    <div style="text-align: center; margin: 30px 0;">
      <!--[if mso]>
        <v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w="urn:schemas-microsoft-com:office:word"
                     href="https://transport.tanjama.fr/groups/join?code=PROD-2025-001"
                     style="height:50px;v-text-anchor:middle; width:200px;" arcsize="10%" stroke="f" fillcolor="#10b981">
          <w:anchorlock/>
          <center style="color:#ffffff; font-family:Arial, sans-serif; font-size:16px; font-weight:bold;">
            Rejoindre le groupe
          </center>
        </v:roundrect>
      <![endif]-->
      <a href="https://transport.tanjama.fr/groups/join?code=PROD-2025-001"
         style="background: #10b981; color: white; padding: 15px 30px; text-decoration: none; border-radius: 6px;
                display: inline-block; font-weight: bold; font-size: 16px;">
        Rejoindre le groupe
      </a>
    </div>

    <!-- Copyable link fallback -->
    <div style="background: #f1f5f9; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #10b981;">
      <p style="margin: 0 0 10px 0; font-size: 14px; color: #64748b; font-weight: bold;">
        ðŸ“± Si le bouton ne fonctionne pas sur mobile :
      </p>
      <p style="margin: 0; font-size: 12px; color: #475569; word-break: break-all;">
        <strong>Copiez et collez ce lien dans votre navigateur :</strong><br>
        <span style="background: white; padding: 8px; border-radius: 4px; display: inline-block; font-family: monospace;">
          https://transport.tanjama.fr/groups/join?code=PROD-2025-001
        </span>
      </p>
    </div>

    <p style="font-size: 13px; color: #64748b;">
      Si vous ne souhaitez pas rejoindre ce groupe, vous pouvez ignorer cet email.
    </p>
  </div>

  <div style="margin-top: 30px; text-align: center;">
    <p style="color: #666; font-size: 12px;">
      EduLift - Gestion collaborative du transport scolaire<br>
      <small>Rendre le transport scolaire plus simple pour les familles.</small>
    </p>
  </div>
</body>
</html>
```

### Family Invitation with Personal Message

**Scenario**: Parent invites another parent with personal message

**Generated Email Content**
```html
<!-- Personal message section -->
<div style="background: #f0f9ff; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #2563eb;">
  <p style="margin: 0; font-style: italic; color: #1e40af;">
    ðŸ’¬ "Salut ! Je t'invite Ã  rejoindre notre groupe de covoiturage pour l'Ã©cole des enfants. On partage les trajets le matin et Ã§a nous fait gagner beaucoup de temps !"
  </p>
</div>

<!-- Invitation link -->
<a href="https://transport.tanjama.fr/families/join?code=FAM-MSG-789">Rejoindre la famille</a>
```

## Push Notification Examples

### Mobile Push Notification Structure

**Group Assignment Notification**
```json
{
  "to": "fcm_device_token_here",
  "notification": {
    "title": "Nouveau conducteur assignÃ©",
    "body": "Marie Martin a Ã©tÃ© assignÃ©e comme conductrice pour le trajet de 8h30 demain"
  },
  "data": {
    "type": "driver_assigned",
    "groupId": "group_123",
    "slotId": "slot_456",
    "datetime": "2025-01-16T08:30:00Z",
    "deepLink": "https://transport.tanjama.fr/groups/group_123/schedule"
  },
  "android": {
    "priority": "high",
    "click_action": "https://transport.tanjama.fr/groups/group_123/schedule"
  },
  "apns": {
    "payload": {
      "aps": {
        "url": "https://transport.tanjama.fr/groups/group_123/schedule"
      }
    }
  }
}
```

**Invitation Received Notification**
```json
{
  "to": "fcm_device_token_here",
  "notification": {
    "title": "Nouvelle invitation",
    "body": "Vous avez Ã©tÃ© invitÃ© Ã  rejoindre le groupe Transport Ã‰cole Primaire Centre"
  },
  "data": {
    "type": "group_invitation",
    "inviteCode": "PROD-2025-001",
    "groupName": "Transport Ã‰cole Primaire Centre",
    "deepLink": "https://transport.tanjama.fr/groups/join?code=PROD-2025-001"
  }
}
```

## API Response Examples

### Group Creation Response
```json
{
  "success": true,
  "data": {
    "group": {
      "id": "group_abc123",
      "name": "Transport Ã‰cole Centre-Ville",
      "timezone": "Europe/Paris"
    },
    "inviteLinks": {
      "email": "https://transport.tanjama.fr/groups/join?code=EMAIL-XYZ789",
      "direct": "https://transport.tanjama.fr/groups/join?code=DIRECT-ABC456",
      "mobile": "edulift://groups/join?code=MOBILE-DEF789"
    }
  },
  "meta": {
    "environment": "production",
    "urlSource": "DEEP_LINK_BASE_URL"
  }
}
```

### Invitation Status Response
```json
{
  "success": true,
  "data": {
    "invitation": {
      "id": "inv_123",
      "code": "PROD-2025-001",
      "status": "pending",
      "expiresAt": "2025-01-22T10:00:00Z"
    },
    "urls": {
      "accept": "https://transport.tanjama.fr/groups/join?code=PROD-2025-001",
      "decline": "https://transport.tanjama.fr/groups/decline?code=PROD-2025-001"
    }
  }
}
```

## Integration Test Examples

### End-to-End Test Scenario

**Test File**: `tests/integration/deep-link-flow.test.ts`

```typescript
describe('Deep Link Integration Tests', () => {
  test('Complete group invitation flow', async () => {
    // 1. Create group
    const groupResponse = await request(app)
      .post('/api/groups')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({
        name: 'Test Integration Group',
        timezone: 'Europe/Paris'
      });

    const groupId = groupResponse.body.data.group.id;

    // 2. Generate invitation
    const inviteResponse = await request(app)
      .post('/api/invitations/group')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({
        groupId,
        email: 'test@example.com'
      });

    const inviteCode = inviteResponse.body.data.invitation.code;

    // 3. Verify deep link format
    const expectedUrl = `${process.env.DEEP_LINK_BASE_URL}groups/join?code=${inviteCode}`;
    expect(inviteResponse.body.data.urls.accept).toBe(expectedUrl);

    // 4. Test deep link access (simulate mobile app)
    const deepLinkResponse = await request(app)
      .get(`/api/deeplink/groups/join?code=${inviteCode}`)
      .expect(200);

    expect(deepLinkResponse.body.data.type).toBe('group_invitation');
    expect(deepLinkResponse.body.data.inviteCode).toBe(inviteCode);

    // 5. Accept invitation via deep link
    const acceptResponse = await request(app)
      .post('/api/groups/join')
      .send({ code: inviteCode })
      .expect(200);

    expect(acceptResponse.body.data.group.id).toBe(groupId);
  });
});
```

### Email Integration Test

```typescript
describe('Email Deep Link Integration', () => {
  test('Group invitation email with correct deep links', async () => {
    const emailService = new TestEmailService();

    const invitationData = {
      groupName: 'Ã‰cole Test Integration',
      inviteCode: 'EMAIL-TEST-123',
      to: 'integration@example.com'
    };

    // Mock email sending
    let sentEmail;
    emailService._send = async (to, subject, html) => {
      sentEmail = { to, subject, html };
    };

    // Send invitation email
    await emailService.sendGroupInvitation(invitationData);

    // Verify email content
    expect(sentEmail.to).toBe('integration@example.com');
    expect(sentEmail.subject).toContain('Ã‰cole Test Integration');

    // Verify deep link in email
    const expectedUrl = `${process.env.DEEP_LINK_BASE_URL}groups/join?code=EMAIL-TEST-123`;
    expect(sentEmail.html).toContain(expectedUrl);

    // Verify fallback link
    expect(sentEmail.html).toContain('Copy and paste this link');
    expect(sentEmail.html).toContain(expectedUrl);
  });
});
```

## Mobile App Integration Examples

### Android Deep Link Handler

```kotlin
// DeepLinkActivity.kt
class DeepLinkActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val deepLink = intent.data
        if (deepLink != null) {
            handleDeepLink(deepLink)
        } else {
            // Fallback to main activity
            startActivity(Intent(this, MainActivity::class.java))
        }
        finish()
    }

    private fun handleDeepLink(uri: Uri) {
        when (uri.host) {
            "groups" -> {
                when (uri.path) {
                    "/join" -> {
                        val code = uri.getQueryParameter("code")
                        if (code != null) {
                            startGroupJoinActivity(code)
                        }
                    }
                }
            }
            "families" -> {
                when (uri.path) {
                    "/join" -> {
                        val code = uri.getQueryParameter("code")
                        if (code != null) {
                            startFamilyJoinActivity(code)
                        }
                    }
                }
            }
        }
    }
}
```

### iOS Deep Link Handler

```swift
// AppDelegate.swift
func application(_ app: UIApplication, open url: URL, options: [UIApplication.OpenURLOptionsKey : Any] = [:]) -> Bool {
    return handleDeepLink(url)
}

func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
    if let url = userActivity.webpageURL {
        return handleDeepLink(url)
    }
    return false
}

private func handleDeepLink(_ url: URL) -> Bool {
    guard let components = URLComponents(url: url, resolvingAgainstBaseURL: true) else {
        return false
    }

    switch components.host {
    case "groups":
        if components.path == "/join", let code = components.queryItems?.first(where: { $0.name == "code" })?.value {
            navigateToGroupJoin(code: code)
            return true
        }
    case "families":
        if components.path == "/join", let code = components.queryItems?.first(where: { $0.name == "code" })?.value {
            navigateToFamilyJoin(code: code)
            return true
        }
    default:
        break
    }

    return false
}
```

## Error Handling Examples

### Invalid Invite Code
```typescript
// API Response for invalid code
{
  "success": false,
  "error": {
    "code": "INVALID_INVITE_CODE",
    "message": "Le code d'invitation n'est pas valide ou a expirÃ©",
    "details": {
      "providedCode": "INVALID-CODE",
      "reason": "not_found"
    }
  }
}
```

### Expired Magic Link
```typescript
// Magic link expiration handling
const handleMagicLink = async (token: string) => {
  try {
    const user = await authService.verifyMagicLink(token);
    return { success: true, user };
  } catch (error) {
    if (error.code === 'TOKEN_EXPIRED') {
      return {
        success: false,
        error: {
          code: 'MAGIC_LINK_EXPIRED',
          message: 'Ce lien de connexion a expirÃ©',
          action: 'request_new_link',
          deepLink: `${process.env.FRONTEND_URL}/auth/login`
        }
      };
    }
    throw error;
  }
};
```

## Performance Examples

### URL Generation Benchmarks
```typescript
// Benchmark URL generation performance
const benchmarkResults = {
  iterations: 10000,
  results: {
    averageTime: "0.15ms",
    totalTime: "1.5s",
    successRate: "100%",
    memoryUsage: "2.3MB"
  },
  breakdown: {
    "DEEP_LINK_BASE_URL": {
      averageTime: "0.12ms",
      successRate: "100%"
    },
    "FRONTEND_URL fallback": {
      averageTime: "0.18ms",
      successRate: "100%"
    },
    "localhost fallback": {
      averageTime: "0.20ms",
      successRate: "100%"
    }
  }
};
```

## Migration Examples

### Legacy URL Format Migration
```typescript
// Old format (before migration)
const oldUrlFormat = {
  groupInvitation: "https://app.edulift.fr/invite?type=group&code=ABC123",
  familyInvitation: "https://app.edulift.fr/invite?type=family&code=DEF456"
};

// New format (after migration)
const newUrlFormat = {
  groupInvitation: "https://transport.tanjama.fr/groups/join?code=ABC123",
  familyInvitation: "https://transport.tanjama.fr/families/join?code=DEF456"
};

// Migration helper function
const migrateLegacyUrl = (oldUrl: string): string => {
  const url = new URL(oldUrl);
  const type = url.searchParams.get('type');
  const code = url.searchParams.get('code');

  if (type === 'group') {
    return `${process.env.DEEP_LINK_BASE_URL}groups/join?code=${code}`;
  } else if (type === 'family') {
    return `${process.env.DEEP_LINK_BASE_URL}families/join?code=${code}`;
  }

  throw new Error('Unknown invitation type');
};
```

## Testing Commands

### Run All Examples
```bash
# Test development environment examples
npm run test:examples -- --env=development

# Test staging environment examples
npm run test:examples -- --env=staging

# Test production environment examples
npm run test:examples -- --env=production

# Test mobile app integration
npm run test:mobile -- --platform=android
npm run test:mobile -- --platform=ios

# Test email template generation
npm run test:email-examples -- --template=group-invitation
npm run test:email-examples -- --template=family-invitation
```

### Generate Test Data
```bash
# Generate test invitations with real codes
npm run generate:test-data -- --type=invitations --count=100

# Generate test emails with current configuration
npm run generate:test-emails -- --env=production --output=./test-emails/

# Validate all deep link formats
npm run validate:deep-links -- --all-environments
```

This comprehensive examples guide demonstrates the EduLift deep link system working in real-world scenarios across all environments and use cases.
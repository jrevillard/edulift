name: CI for Workflow Changes

on:
  push:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  validate-workflows:
    name: Validate Workflow Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          echo "Validating workflow YAML files..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read file; do
            echo "Validating $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          echo "✅ All YAML files are valid"

      - name: Check for common workflow issues
        run: |
          echo "Checking for common workflow configuration issues..."

          # Check if CD has proper CI dependencies
          if grep -q "workflow_run:" .github/workflows/cd.yml; then
            echo "✅ CD uses workflow_run trigger"
          else
            echo "⚠️ CD doesn't use workflow_run trigger"
          fi

          # Check if workflows have proper names
          if grep -q "name:" .github/workflows/*.yml; then
            echo "✅ All workflows have names"
          fi

          echo "✅ Workflow validation completed"

      - name: Basic workflow logic test
        run: |
          echo "Testing workflow logic..."

          # Test that CI workflows would trigger for frontend changes
          if [ -f "frontend/package.json" ]; then
            echo "✅ Frontend structure detected"
          fi

          # Test that CI workflows would trigger for backend changes
          if [ -f "backend/package.json" ]; then
            echo "✅ Backend structure detected"
          fi

          echo "✅ Basic validation passed"
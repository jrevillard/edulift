#!/bin/bash

# Pre-commit hook for EduLift project
# Runs quality checks before allowing commit

set -e

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if backend files are modified
BACKEND_CHANGED=false
FRONTEND_CHANGED=false

for file in $STAGED_FILES; do
    if [[ $file == backend/* ]]; then
        BACKEND_CHANGED=true
    fi
    if [[ $file == frontend/* ]]; then
        FRONTEND_CHANGED=true
    fi
done

# Function to print colored output
print_success() {
    echo "‚úÖ $1"
}

print_error() {
    echo "‚ùå $1"
}

print_info() {
    echo "‚ÑπÔ∏è  $1"
}

# Backend checks
if [ "$BACKEND_CHANGED" = true ]; then
    echo ""
    print_info "Backend files modified. Running backend checks..."

    # Navigate to backend directory
    cd /workspace/backend

    # Check if API files have changed
    API_FILES_CHANGED=$(git diff --cached --name-only | grep -E "(src/routes/|src/schemas/|src/controllers/)" | wc -l)

    if [ "$API_FILES_CHANGED" -gt 0 ]; then
        print_info "API files detected. Generating OpenAPI specification..."

        # Generate OpenAPI specification
        if npm run swagger:generate; then
            print_success "OpenAPI generation successful"

            # Check if swagger.json was actually modified
            if ! git diff --quiet docs/openapi/swagger.json; then
                print_info "Staging updated OpenAPI specification..."
                git add docs/openapi/swagger.json
            else
                print_info "OpenAPI specification already up to date"
            fi

            # Validate OpenAPI specification
            if npx @redocly/cli lint docs/openapi/swagger.json 2>/dev/null; then
                print_success "OpenAPI validation passed"
            else
                print_error "OpenAPI validation failed"
                echo "Please fix the OpenAPI issues before committing."
                exit 1
            fi
        else
            print_error "OpenAPI generation failed"
            echo "Please fix the generation errors before committing."
            exit 1
        fi
    fi

    # TypeScript type checking
    echo "üîé Running TypeScript type checking..."
    if npm run typecheck; then
        print_success "TypeScript type checking passed"
    else
        print_error "TypeScript type checking failed"
        echo "Please fix the TypeScript errors before committing."
        exit 1
    fi

    # Linting
    echo "üîç Running ESLint..."
    if npm run lint; then
        print_success "Linting passed"
    else
        print_error "Linting failed"
        echo "Please fix the linting errors before committing."
        echo "You can run 'npm run lint:fix' to automatically fix some errors."
        exit 1
    fi

    # Run tests - mandatory
    print_info "Running tests..."
    if npm run test:ci; then
        print_success "Tests passed"
    else
        print_error "Tests failed"
        echo "Please fix the failing tests before committing."
        echo "You can run 'npm test' to see the full test output."
        exit 1
    fi

    cd ..
fi

# Frontend checks
if [ "$FRONTEND_CHANGED" = true ]; then
    echo ""
    print_info "Frontend files modified. Running frontend checks..."

    # Navigate to frontend directory
    cd /workspace/frontend

    # TypeScript type checking
    echo "üîé Running TypeScript type checking..."
    if npm run typecheck; then
        print_success "TypeScript type checking passed"
    else
        print_error "TypeScript type checking failed"
        echo "Please fix the TypeScript errors before committing."
        exit 1
    fi

    # Linting
    echo "üîç Running ESLint..."
    if npm run lint; then
        print_success "Linting passed"
    else
        print_error "Linting failed"
        echo "Please fix the linting errors before committing."
        echo "You can run 'npm run lint:fix' to automatically fix some errors."
        exit 1
    fi

    # Run tests - mandatory
    print_info "Running tests..."
    if npm run test:run; then
        print_success "Tests passed"
    else
        print_error "Tests failed"
        echo "Please fix the failing tests before committing."
        echo "You can run 'npm test' to see the full test output."
        exit 1
    fi

    cd ..
fi

# If no code files were changed
if [ "$BACKEND_CHANGED" = false ] && [ "$FRONTEND_CHANGED" = false ]; then
    print_info "No code files modified, skipping checks"
fi

echo ""
print_success "All pre-commit checks passed! üéâ"
echo "Proceeding with commit..."
#!/bin/bash
set -euo pipefail

# EduLift Backup Script
# Generated by Ansible - DO NOT EDIT MANUALLY

BACKUP_DIR="{{ edulift_deploy_dir }}/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
COMPOSE_PROJECT="{{ compose_project_name }}"
DB_USER="{{ postgres_user }}"
DB_NAME="{{ postgres_db }}"
RETENTION_DAYS={{ edulift_deployment.backup.retention_days }}

# Ensure backup directory exists
mkdir -p "${BACKUP_DIR}"

# Perform database dump using docker compose exec
cd "{{ edulift_deploy_dir }}"
docker compose -p "${COMPOSE_PROJECT}" exec -T postgres pg_dump -U "${DB_USER}" -d "${DB_NAME}" | gzip > "${BACKUP_DIR}/backup_${TIMESTAMP}.sql.gz"

# Prune old backups
find "${BACKUP_DIR}" -name "backup_*.sql.gz" -mtime "+${RETENTION_DAYS}" -delete

echo "Backup completed: backup_${TIMESTAMP}.sql.gz"

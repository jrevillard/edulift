# EduLift Environment Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY
# Environment: {{ deployment_environment }}

{# Import URL helper macros #}
{% import '_url_macros.j2' as url %}

{# Compute service URLs with defaults #}
{% set protocol = edulift_deployment.protocol | default('https') %}
{% set base_domain = edulift_deployment.domain %}
{% set http_port = edulift_services.traefik.ports.http %}
{% set https_port = edulift_services.traefik.ports.https %}

{# Compute service URLs with defaults #}
{% set protocol = edulift_deployment.protocol | default('https') %}
{% set base_domain = edulift_deployment.domain %}
{% set http_port = edulift_services.traefik.ports.http %}
{% set https_port = edulift_services.traefik.ports.https %}

{# Build URLs with port configuration #}
{% if https_port == 443 %}
  {# Standard HTTPS port - no port needed in URL #}
  {% set frontend_url = protocol + '://' + base_domain %}
  {% set backend_base_url = protocol + '://' + base_domain %}
  {% set traefik_url = protocol + '://' + base_domain + '/traefik' %}
{% else %}
  {# Custom HTTPS port - include port in URL #}
  {% set frontend_url = protocol + '://' + base_domain + ':' + https_port|string %}
  {% set backend_base_url = protocol + '://' + base_domain + ':' + https_port|string %}
  {% set traefik_url = protocol + '://' + base_domain + ':' + https_port|string + '/traefik' %}
{% endif %}

{# Build specific service URLs #}
{% set backend_url = backend_base_url + '/api' %}
{% set cors_origins = [frontend_url] %}

{% set cors_origins = [frontend_url] %}

{# Generate DEEP_LINK_BASE_URL using macro #}
{% set deep_link_base_url = url.deep_link_url(deployment_environment, protocol, base_domain, https_port) %}

{# Override with custom URLs if defined #}
{% if edulift_deployment.urls is defined and edulift_deployment.urls is not none %}
  {% if edulift_deployment.urls.frontend is defined and edulift_deployment.urls.frontend is not none %}
    {% set frontend_url = edulift_deployment.urls.frontend %}
  {% endif %}
  {% if edulift_deployment.urls.backend is defined and edulift_deployment.urls.backend is not none %}
    {% set backend_url = edulift_deployment.urls.backend %}
  {% endif %}
  {% if edulift_deployment.urls.traefik_dashboard is defined and edulift_deployment.urls.traefik_dashboard is not none %}
    {% set traefik_url = edulift_deployment.urls.traefik_dashboard %}
  {% endif %}
  {% if edulift_deployment.urls.deep_link_base is defined and edulift_deployment.urls.deep_link_base is not none %}
    {% set deep_link_base_url = edulift_deployment.urls.deep_link_base %}
  {% endif %}
{% endif %}

{# Override CORS origins if defined #}
{% if edulift_deployment.cors_origins is defined and edulift_deployment.cors_origins is not none %}
  {% set cors_origins = edulift_deployment.cors_origins %}
{% endif %}

# Application
NODE_ENV={{ node_env | default('production') }}
PORT={{ edulift_services.backend.port }}
FRONTEND_URL={{ frontend_url }}
DEEP_LINK_BASE_URL={{ deep_link_base_url }}
CORS_ORIGIN={{ cors_origins | join(',') }}

# Mobile Store URLs (for deep links)
VITE_APP_STORE_URL={{ edulift_stores.app_store_url }}
VITE_PLAY_STORE_URL={{ edulift_stores.play_store_url }}

# Frontend API Configuration (build args only, not runtime)
# VITE_API_URL and VITE_SOCKET_URL are passed as build args to frontend container

# Logging Configuration
# LOG_LEVEL controls verbosity: error, warn, info, debug
LOG_LEVEL={{ log_level | default('info') }}
# LOG_PRETTY controls formatting: true for colored logs, false for JSON
LOG_PRETTY={{ log_pretty | default('false') }}
# HTTP_LOG_FORMAT controls Morgan HTTP request logging: 'dev' (detailed), 'combined' (compact), 'tiny', etc.
HTTP_LOG_FORMAT={{ http_log_format | default('combined') }}

# Node Environment (for application optimizations, independent of logging)
NODE_ENV={{ node_env | default('production') }}

# Rate Limiting
RATE_LIMIT_ENABLED={{ rate_limit_enabled | default('true') }}
RATE_LIMIT_WINDOW_MS={{ rate_limit_window_ms | default('60000') }}
RATE_LIMIT_MAX_REQUESTS={{ rate_limit_max_requests | default('300') }}

# Database
DATABASE_URL=postgresql://{{ postgres_user }}:{{ postgres_password }}@postgres:5432/{{ postgres_db }}?connection_limit=20&pool_timeout=20&connect_timeout=10

# Redis
REDIS_URL=redis://:{{ redis_password }}@redis:6379

# Security
# JWT Configuration (Dual-Token System for Mobile)
JWT_ACCESS_SECRET={{ jwt_access_secret }}
JWT_REFRESH_EXPIRY_DAYS={{ jwt_refresh_expiry_days | default(60) }}
REFRESH_GRACE_PERIOD_MINUTES={{ refresh_grace_period_minutes | default(5) }}

# Magic Link Authentication
MAGIC_LINK_EXPIRES_IN={{ magic_link_expires_in | default('10m') }}

# Email
EMAIL_HOST={{ email_host }}
EMAIL_PORT={{ email_port }}
EMAIL_USER={{ email_user }}
EMAIL_PASSWORD={{ email_password }}
EMAIL_ENCRYPTION={{ email_encryption | default('STARTTLS') }}

# Firebase Cloud Messaging (Push Notifications)
FIREBASE_NOTIFICATIONS_ENABLED={{ firebase_notifications_enabled | default('true') }}
FIREBASE_PROJECT_ID={{ firebase_project_id }}
FIREBASE_CLIENT_EMAIL={{ firebase_client_email }}
FIREBASE_PRIVATE_KEY={{ firebase_private_key | regex_replace('\n', '\\n') | quote }}
